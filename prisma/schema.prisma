generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../feelin_pay.db"
}

// Tabla de roles
model Rol {
  id          String   @id @default(uuid())
  nombre      String   @unique // "super_admin", "propietario", "empleado"
  descripcion String
  activo      Boolean  @default(true)
  
  // Auditoría
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  usuarios    Usuario[]
  permisos    RolPermiso[]
  
  @@map("roles")
}

// Tabla de permisos - SISTEMA GRANULAR DE SEGURIDAD
model Permiso {
  id          String   @id @default(uuid())
  nombre      String   @unique // "gestionar_usuarios", "ver_reportes", "registrar_empleados"
  descripcion String
  modulo      String   // "usuarios", "reportes", "empleados", "pagos", "licencias"
  accion      String   @default("read") // "create", "read", "update", "delete", "inhabilitar", "reactivar"
  activo      Boolean  @default(true)
  
  // Auditoría
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  roles       RolPermiso[]
  
  @@unique([modulo, accion])
  @@map("permisos")
}

// Tabla de relación roles-permisos - CONTROL GRANULAR
model RolPermiso {
  id        String   @id @default(uuid())
  rolId     String
  permisoId String
  
  // Auditoría
  createdAt DateTime @default(now())
  
  rol       Rol      @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso   Permiso  @relation(fields: [permisoId], references: [id], onDelete: Cascade)
  
  @@unique([rolId, permisoId])
  @@map("rol_permisos")
}

model Usuario {
  id                  String   @id @default(uuid())
  nombre              String
  telefono            String
  email               String   @unique
  password            String
  rolId               String   // Referencia al rol
  googleSpreadsheetId String   // ID único de Google Sheets para cada usuario
  activo              Boolean  @default(true)
  
  // Sistema de prueba
  enPeriodoPrueba     Boolean  @default(false)
  fechaInicioPrueba   DateTime?
  diasPruebaRestantes  Int      @default(0)
  
  // Verificación de email
  emailVerificado     Boolean  @default(false)
  emailVerificadoAt   DateTime?
  
  // Sistema de intentos OTP (integrado en usuario)
  otpAttemptsToday    Int      @default(0)
  lastOtpAttemptDate  DateTime?
  
  // Auditoría
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  lastLoginAt         DateTime?
  
  // Relaciones
  rol                 Rol      @relation(fields: [rolId], references: [id])
  empleados           Empleado[]
  pagos               Pago[]
  membresias          Membresia[]
  
  // Índices para optimizar consultas
  @@index([email])
  @@index([activo])
  @@index([rolId])
  @@map("usuarios")
}

model Empleado {
  id        String   @id @default(uuid())
  usuarioId String   // ID del usuario (super admin o propietario)
  nombre    String   // Nombre del empleado
  telefono  String   // Número de teléfono completo (incluye código de país)
  activo    Boolean  @default(true)
  
  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  
  // Relaciones para notificaciones y horarios
  configuracionNotificacion ConfiguracionNotificacion?
  horariosLaborales         HorarioLaboral[]
  breaksLaborales           BreakLaboral[]
  historialNotificaciones   HistorialNotificacion[]
  
  // Índices para optimizar consultas
  @@index([usuarioId])
  @@index([activo])
  @@map("empleados")
}

model Pago {
  id                    String   @id @default(uuid())
  usuarioId             String
  nombrePagador         String   // Nombre del pagador
  monto                 Float
  fecha                 DateTime
  codigoSeguridad       String   @unique // Código de seguridad de Yape (único)
  registradoEnSheets    Boolean  @default(false)
  notificadoEmpleados   Boolean  @default(false)
  
  // Campos adicionales
  numeroTelefono        String?  // Número de teléfono del pagador
  mensajeOriginal       String?  // Mensaje original de la notificación
  
  // Auditoría
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  procesadoAt           DateTime?
  
  usuario               Usuario @relation(fields: [usuarioId], references: [id])
  
  // Índices para optimizar consultas
  @@index([usuarioId])
  @@index([fecha])
  @@index([registradoEnSheets])
  @@index([codigoSeguridad])
  @@map("pagos")
}

// Membresías mensuales de usuarios
model Membresia {
  id              String   @id @default(uuid())
  usuarioId       String
  tipo            String   // "basica", "premium", "empresarial"
  fechaInicio     DateTime
  fechaExpiracion DateTime
  activa          Boolean  @default(true)
  diasRestantes   Int      // Días restantes de la membresía
  precio          Float    // Precio pagado por la membresía
  
  // Auditoría
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  activadaAt      DateTime?
  
  usuario         Usuario @relation(fields: [usuarioId], references: [id])
  
  @@map("membresias")
}

// ========================================
// SISTEMA DE NOTIFICACIONES Y HORARIOS LABORALES
// ========================================

// Configuración de notificaciones por empleado
model ConfiguracionNotificacion {
  id                    String   @id @default(uuid())
  empleadoId            String   @unique
  notificacionesActivas Boolean  @default(true)
  
  // Zona horaria del empleado
  zonaHoraria          String   @default("America/Lima")
  
  // Configuración de notificaciones
  notificarPagos       Boolean  @default(true)  // Notificar cuando lleguen pagos
  notificarRecordatorios Boolean @default(false) // Notificar recordatorios
  notificarReportes    Boolean  @default(false) // Notificar reportes diarios
  
  // Horarios de notificación (opcional - para notificaciones no urgentes)
  horaInicioNotificaciones String? // "08:00" - Solo notificar después de esta hora
  horaFinNotificaciones   String? // "20:00" - Solo notificar antes de esta hora
  
  // Auditoría
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relación
  empleado             Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  
  @@map("configuracion_notificaciones")
}

// Horarios laborales por día de la semana
model HorarioLaboral {
  id           String   @id @default(uuid())
  empleadoId   String
  diaSemana    Int      // 1=Lunes, 2=Martes, 3=Miércoles, 4=Jueves, 5=Viernes, 6=Sábado, 7=Domingo
  horaInicio   String   // "09:00" formato 24h
  horaFin      String   // "18:00" formato 24h
  activo       Boolean  @default(true)
  
  // Descripción opcional del horario
  descripcion  String?  // "Horario matutino", "Turno nocturno", etc.
  
  // Auditoría
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relación
  empleado     Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  
  // Constraint único por empleado y día
  @@unique([empleadoId, diaSemana])
  @@map("horarios_laborales")
}

// Breaks o descansos laborales por día
model BreakLaboral {
  id           String   @id @default(uuid())
  empleadoId   String
  diaSemana    Int      // 1=Lunes, 2=Martes, 3=Miércoles, 4=Jueves, 5=Viernes, 6=Sábado, 7=Domingo
  horaInicio   String   // "12:00" formato 24h
  horaFin      String   // "13:00" formato 24h
  activo       Boolean  @default(true)
  
  // Tipo de break
  tipo         String   @default("ALMUERZO") // "ALMUERZO", "DESCANSO", "CAFE", "OTRO"
  descripcion  String?  // "Break de almuerzo", "Descanso de 15 min", etc.
  
  // Auditoría
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relación
  empleado     Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  
  // Constraint único por empleado, día y tipo
  @@unique([empleadoId, diaSemana, tipo])
  @@map("breaks_laborales")
}

// Historial de notificaciones enviadas (para auditoría y control)
model HistorialNotificacion {
  id              String   @id @default(uuid())
  empleadoId      String
  tipo            String   // "PAGO_RECIBIDO", "RECORDATORIO", "REPORTE_DIARIO", "OTRO"
  mensaje         String   // Contenido del mensaje enviado
  telefonoDestino String   // Teléfono al que se envió
  enviado         Boolean  @default(false)
  errorEnvio      String?  // Mensaje de error si falló el envío
  
  // Metadatos del envío
  fechaProgramada DateTime // Cuándo se programó enviar
  fechaEnviado    DateTime? // Cuándo se envió realmente
  intentosEnvio   Int      @default(0) // Número de intentos de envío
  
  // Auditoría
  createdAt       DateTime @default(now())
  
  // Relación
  empleado        Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  
  // Índices para optimizar consultas
  @@index([empleadoId])
  @@index([tipo])
  @@index([enviado])
  @@index([fechaProgramada])
  @@map("historial_notificaciones")
}

// Modelo simplificado para códigos OTP (solo uno por usuario)
model OtpCode {
  id          String   @id @default(uuid())
  email       String   // Email del usuario
  codigo      String   // Código de 6 dígitos
  tipo        String   // "EMAIL_VERIFICATION", "PASSWORD_RESET", "LOGIN_VERIFICATION"
  expiraEn    DateTime // 10 minutos desde creación
  usado       Boolean  @default(false)
  intentos    Int      @default(0) // Número de intentos fallidos
  maxIntentos Int      @default(3) // Máximo 3 intentos
  
  // Auditoría
  createdAt   DateTime @default(now())
  
  // Constraint único por email y tipo
  @@unique([email, tipo])
  @@map("otp_codes")
}