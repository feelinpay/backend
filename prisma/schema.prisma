generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Tabla de roles
model Rol {
  id          String   @id @default(uuid())
  nombre      String   @unique // "super_admin", "propietario", "empleado"
  descripcion String
  activo      Boolean  @default(true)
  
  // Auditoría
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  usuarios    Usuario[]
  permisos    RolPermiso[]
  
  @@map("roles")
}

// Tabla de permisos - SISTEMA GRANULAR DE SEGURIDAD
model Permiso {
  id        String   @id @default(uuid())
  nombre    String   // Display Name
  modulo    String   // Module
  ruta      String?  // Frontend route
  activo    Boolean  @default(true)

  // Auditoría
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles       RolPermiso[]

  @@map("permisos")
}

// Tabla de relación roles-permisos - CONTROL GRANULAR
model RolPermiso {
  id        String   @id @default(uuid())
  rolId     String
  permisoId String
  
  // Auditoría
  createdAt DateTime @default(now())
  
  rol       Rol      @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso   Permiso  @relation(fields: [permisoId], references: [id], onDelete: Cascade)
  
  @@unique([rolId, permisoId])
  @@map("rol_permisos")
}

model Usuario {
  id                  String   @id @default(uuid())
  nombre              String
  email               String   @unique
  imagen              String?  // URL de la imagen de perfil (Google o personalizada)
  googleId            String   @unique // ID de Google para autenticación
  rolId               String   // Referencia al rol
  googleDriveFolderId String?  // ID de la carpeta de Google Drive del usuario
  activo              Boolean  @default(true)
  
  // Sistema de prueba
  fechaInicioPrueba   DateTime?
  fechaFinPrueba      DateTime? // Fecha exacta de fin de prueba
  
  // Auditoría
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  lastLoginAt         DateTime?
  
  // Relaciones
  rol                 Rol      @relation(fields: [rolId], references: [id])
  empleados           Empleado[]
  membresias          MembresiaUsuario[]
  
  // Índices para optimizar consultas
  @@index([email])
  @@index([activo])
  @@index([rolId])
  @@map("usuarios")
}

model Empleado {
  id        String   @id @default(uuid())
  usuarioId String   // ID del usuario (super admin o propietario)
  nombre    String   // Nombre del empleado
  telefono  String   // Número de teléfono completo (incluye código de país)
  activo    Boolean  @default(true)
  
  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  
  // Relaciones para notificaciones y horarios

  horariosLaborales         HorarioLaboral[]
  
  // Índices para optimizar consultas
  @@index([usuarioId])
  @@index([activo])
  @@map("empleados")
}



// Catálogo de membresías disponibles
model Membresia {
  id              String   @id @default(uuid())
  nombre          String   // "Membresía Básica", "Membresía Premium", etc.
  meses           Int      // 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12 meses
  precio          Float    // Precio por esta membresía
  activa          Boolean  @default(true)
  
  // Auditoría
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relación con usuarios que tienen esta membresía
  usuarios        MembresiaUsuario[]
  
  // Índices para optimizar consultas
  @@index([activa])
  @@map("membresias")
}

// Control de membresías por usuario
model MembresiaUsuario {
  id              String   @id @default(uuid())
  usuarioId       String
  membresiaId     String
  fechaInicio     DateTime
  fechaExpiracion DateTime
  activa          Boolean  @default(true)
  
  // Auditoría
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  usuario         Usuario @relation(fields: [usuarioId], references: [id])
  membresia       Membresia @relation(fields: [membresiaId], references: [id])
  
  // Índices para optimizar consultas
  @@index([usuarioId])
  @@index([activa])
  @@index([fechaExpiracion])
  @@map("membresias_usuarios")
}

// ========================================
// SISTEMA DE NOTIFICACIONES Y HORARIOS LABORALES
// ========================================

// Horarios laborales por día de la semana
model HorarioLaboral {
  id           String   @id @default(uuid())
  empleadoId   String
  diaSemana    String   // "Lunes", "Martes", etc.
  horaInicio   String   // "09:00" formato 24h
  horaFin      String   // "18:00" formato 24h
  activo       Boolean  @default(true)
  
  // Auditoría
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relación
  empleado     Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  
  // Permitir múltiples horarios por día (Horario Partido)
  @@index([empleadoId, diaSemana])
  @@map("horarios_laborales")
}
